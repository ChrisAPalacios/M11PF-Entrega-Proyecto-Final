DROP DATABASE IF EXISTS eventia;
CREATE DATABASE eventia;
USE eventia;

-- ===== CATÁLOGO =====
CREATE TABLE ALCALDIA (
    ID_ALCALDIA INT AUTO_INCREMENT PRIMARY KEY,
    NOMBRE_ALCALDIA VARCHAR(40) UNIQUE NOT NULL
);

CREATE TABLE COLONIA (
    ID_COLONIA INT AUTO_INCREMENT PRIMARY KEY,
    NOMBRE_COLONIA VARCHAR(50) UNIQUE NOT NULL,
    ID_ALCALDIA INT,
    CONSTRAINT FK_ALCALDIA_COLONIA FOREIGN KEY (ID_ALCALDIA)
        REFERENCES ALCALDIA(ID_ALCALDIA) ON DELETE CASCADE
);

CREATE TABLE ZONA (
    ID_ZONA INT AUTO_INCREMENT PRIMARY KEY,
    NOMBREZONA VARCHAR(150) NOT NULL,
    PRECIO DECIMAL(7,2) NOT NULL,
    CAPACIDAD INT CHECK (CAPACIDAD >= 0)
);

CREATE TABLE TIPO_EVENTO (
    ID_TIPOEVENTO INT AUTO_INCREMENT PRIMARY KEY,
    TIPO VARCHAR(150) UNIQUE NOT NULL
);

-- ===== USUARIOS =====
CREATE TABLE USUARIO (
    ID_USUARIO INT AUTO_INCREMENT PRIMARY KEY,
    PILA VARCHAR(150) NOT NULL,
    AP_PATERNO VARCHAR(150) NOT NULL,
    AP_MATERNO VARCHAR(150),
    CORREO VARCHAR(150) UNIQUE NOT NULL,
    TELEFONO BIGINT(10) NOT NULL CHECK (LENGTH(TELEFONO) = 10),
    TIPOUSUARIO ENUM('CLIENTE', 'ADMINI') NOT NULL,
    PASSWORD VARCHAR(100) NOT NULL
);

CREATE TABLE CLIENTE (
    ID_USUARIO INT PRIMARY KEY,
    FECHA_REGISTRO DATE NOT NULL,
    METODO_PAGO ENUM('PAYPAL', 'CREDITO', 'DEBITO') NOT NULL,
    CONSTRAINT FK_USUARIOCLIENTE FOREIGN KEY (ID_USUARIO)
        REFERENCES USUARIO(ID_USUARIO) ON DELETE CASCADE
);

CREATE TABLE ADMINI (
    ID_USUARIO INT PRIMARY KEY,
    RFC VARCHAR(13) NOT NULL,
    FECHA_ALTA DATE NOT NULL,
    CONSTRAINT FK_USUARIOADMINI FOREIGN KEY (ID_USUARIO)
        REFERENCES USUARIO(ID_USUARIO) ON DELETE CASCADE
);

CREATE TABLE DIRECCION (
    ID_DIRECCION INT AUTO_INCREMENT PRIMARY KEY,
    CALLE VARCHAR(150) NOT NULL,
    NUMINT VARCHAR(10),
    NUMEXT VARCHAR(10) NOT NULL,
    ID_USUARIO INT NOT NULL,
    ID_ALCALDIA INT NOT NULL,
    CONSTRAINT FK_ALCALDIA FOREIGN KEY (ID_ALCALDIA)
        REFERENCES ALCALDIA(ID_ALCALDIA) ON DELETE CASCADE,
    CONSTRAINT FK_USUARIOD FOREIGN KEY (ID_USUARIO)
        REFERENCES USUARIO(ID_USUARIO) ON DELETE CASCADE
);

-- ===== EVENTOS Y BOLETOS =====
CREATE TABLE EVENTO (
    ID_EVENTO INT AUTO_INCREMENT PRIMARY KEY,
    NOMBRE_EVENTO VARCHAR(150) NOT NULL,
    FECHA DATE,
    DURACION INT,
    ID_TIPOEVENTO INT NOT NULL,
    POSTER VARCHAR (150),
    CONSTRAINT FK_TIPO_EVENTO_BOLETO FOREIGN KEY (ID_TIPOEVENTO)
        REFERENCES TIPO_EVENTO(ID_TIPOEVENTO) ON DELETE CASCADE
);



CREATE TABLE ASIENTO (
    ID_ASIENTO INT AUTO_INCREMENT PRIMARY KEY,
    NUMERO_ASIENTO VARCHAR(150) NOT NULL,
    ID_ZONA INT NOT NULL,
    CONSTRAINT FK_ASIENTO_ZONA FOREIGN KEY (ID_ZONA)
        REFERENCES ZONA(ID_ZONA) ON DELETE CASCADE
);

CREATE TABLE ASIENTO_EVENTO (
    ID_EVENTO INT NOT NULL,
    ID_ASIENTO INT NOT NULL,
    ESTADO VARCHAR(20) DEFAULT 'DISPONIBLE',
    PRIMARY KEY (ID_EVENTO, ID_ASIENTO),
    CONSTRAINT FK_ASIENTO_EVENTO_EVENTO FOREIGN KEY (ID_EVENTO)
        REFERENCES EVENTO(ID_EVENTO) ON DELETE CASCADE,
    CONSTRAINT FK_ASIENTO_EVENTO_ASIENTO FOREIGN KEY (ID_ASIENTO)
        REFERENCES ASIENTO(ID_ASIENTO) ON DELETE CASCADE
);


-- ===== COMPRA primero para evitar error de clave foránea =====
CREATE TABLE COMPRA (
    ID_COMPRA INT AUTO_INCREMENT PRIMARY KEY,
    FECHACOMPRA DATE NOT NULL,
    MONTOTOTAL DECIMAL(20,2),
    ID_USUARIO INT NOT NULL,
    ID_DEVOLUCION INT, -- Esto se agregará correctamente después con ALTER TABLE
    CONSTRAINT FK_COMPRA_USUARIO FOREIGN KEY (ID_USUARIO)
        REFERENCES CLIENTE(ID_USUARIO) ON DELETE CASCADE
);

-- ===== DEVOLUCION después, con referencia a COMPRA
CREATE TABLE DEVOLUCION (
    ID_DEVOLUCION INT AUTO_INCREMENT PRIMARY KEY,
    FECHA_DEVOLUCION DATE,
    MOTIVO TEXT,
    ID_COMPRA INT UNIQUE,
    CONSTRAINT FK_DEVOLUCION_COMPRA FOREIGN KEY (ID_COMPRA)
        REFERENCES COMPRA(ID_COMPRA) ON DELETE CASCADE
);

-- ===== Relación circular se resuelve con ALTER TABLE
ALTER TABLE COMPRA
    ADD CONSTRAINT FK_COMPRA_DEVOLUCION FOREIGN KEY (ID_DEVOLUCION)
    REFERENCES DEVOLUCION(ID_DEVOLUCION) ON DELETE CASCADE;

-- ===== BOLETOS
CREATE TABLE BOLETO (
    ID_BOLETO INT AUTO_INCREMENT PRIMARY KEY,
    ESTADO ENUM('Disponible', 'Vendido', 'Reservado') NOT NULL,
    ID_USUARIO INT NOT NULL,
    ID_ASIENTO INT NOT NULL,
    ID_EVENTO INT NOT NULL,
    ID_COMPRA INT NOT NULL,
    ID_DEVOLUCION INT,
    CONSTRAINT FK_USUARIO_CLIENTE_BOLETO FOREIGN KEY (ID_USUARIO)
        REFERENCES CLIENTE(ID_USUARIO) ON DELETE CASCADE,
    CONSTRAINT FK_BOLETO_ASIENTO FOREIGN KEY (ID_ASIENTO)
        REFERENCES ASIENTO(ID_ASIENTO) ON DELETE CASCADE,
    CONSTRAINT FK_BOLETO_EVENTO FOREIGN KEY (ID_EVENTO)
        REFERENCES EVENTO(ID_EVENTO) ON DELETE CASCADE,
    CONSTRAINT FK_BOLETO_COMPRA FOREIGN KEY (ID_COMPRA)
        REFERENCES COMPRA(ID_COMPRA) ON DELETE CASCADE,
    CONSTRAINT FK_BOLETO_DEVOLUCION FOREIGN KEY (ID_DEVOLUCION)
        REFERENCES DEVOLUCION(ID_DEVOLUCION) ON DELETE SET NULL
);

INSERT INTO USUARIO (
    PILA, AP_PATERNO, AP_MATERNO, CORREO, TELEFONO, TIPOUSUARIO, PASSWORD
) VALUES (
    'Admin', 'Sistema', 'Principal', 'admin@eventia.com', 5551234567, 'ADMINI', 'admin123'
);

INSERT INTO admini(
	ID_USUARIO,RFC,FECHA_ALTA
) VALUES(
	'1','XAXX010101AB1','2025-04-02'
);



INSERT INTO TIPO_EVENTO (ID_TIPOEVENTO, TIPO) VALUES (1, 'Rock');
INSERT INTO TIPO_EVENTO (ID_TIPOEVENTO, TIPO) VALUES (2, 'Pop');
INSERT INTO TIPO_EVENTO (ID_TIPOEVENTO, TIPO) VALUES (3, 'Folklor');
INSERT INTO TIPO_EVENTO (ID_TIPOEVENTO, TIPO) VALUES (4, 'Reguetón');
INSERT INTO TIPO_EVENTO (ID_TIPOEVENTO, TIPO) VALUES (5, 'Electrónica');
INSERT INTO TIPO_EVENTO (ID_TIPOEVENTO, TIPO) VALUES (6, 'Hip-Hop');
INSERT INTO TIPO_EVENTO (ID_TIPOEVENTO, TIPO) VALUES (7, 'Indie');

INSERT INTO EVENTO (ID_EVENTO, NOMBRE_EVENTO, FECHA, DURACION, ID_TIPOEVENTO) VALUES (1, 'Zoe Memorex', '2025-06-10', 180, 7);
INSERT INTO EVENTO (ID_EVENTO, NOMBRE_EVENTO, FECHA, DURACION, ID_TIPOEVENTO) VALUES (2, 'Rels B AfroLOVA', '2025-07-22', 150, 4);
INSERT INTO EVENTO (ID_EVENTO, NOMBRE_EVENTO, FECHA, DURACION, ID_TIPOEVENTO) VALUES (3, 'Taylor Swift Eras Tour', '2025-08-15', 210, 2);
INSERT INTO EVENTO (ID_EVENTO, NOMBRE_EVENTO, FECHA, DURACION, ID_TIPOEVENTO) VALUES (4, 'Kevin Kaarl ULTRA SODADE', '2025-09-05', 120, 3);
INSERT INTO EVENTO (ID_EVENTO, NOMBRE_EVENTO, FECHA, DURACION, ID_TIPOEVENTO) VALUES (5, 'Rolling Stones', '2025-10-10', 200, 1);
INSERT INTO EVENTO (ID_EVENTO, NOMBRE_EVENTO, FECHA, DURACION, ID_TIPOEVENTO) VALUES (6, 'Bad Bunny DeBí TiRAR MÁS FOTOs', '2025-11-20', 180, 4);
INSERT INTO EVENTO (ID_EVENTO, NOMBRE_EVENTO, FECHA, DURACION, ID_TIPOEVENTO) VALUES (7, 'NSQK', '2025-12-08', 160, 4);
INSERT INTO EVENTO (ID_EVENTO, NOMBRE_EVENTO, FECHA, DURACION, ID_TIPOEVENTO) VALUES (8, 'Tomorrowland Festival', '2025-12-25', 300, 5);
INSERT INTO EVENTO (ID_EVENTO, NOMBRE_EVENTO, FECHA, DURACION, ID_TIPOEVENTO) VALUES (9, 'Humbe', '2025-04-26', 120, 2);




INSERT INTO ZONA (ID_ZONA, NOMBREZONA, PRECIO, CAPACIDAD) VALUES (1, 'VIP', 2500.00, 10);
INSERT INTO ZONA (ID_ZONA, NOMBREZONA, PRECIO, CAPACIDAD) VALUES (2, 'General', 800.00, 15);
INSERT INTO ZONA (ID_ZONA, NOMBREZONA, PRECIO, CAPACIDAD) VALUES (3, 'Preferente', 1500.00, 20);
INSERT INTO ZONA (ID_ZONA, NOMBREZONA, PRECIO, CAPACIDAD) VALUES (4, 'Grada Baja', 1000.00, 25);




INSERT INTO ALCALDIA (NOMBRE_ALCALDIA) VALUES 
('Álvaro Obregón'),
('Azcapotzalco'),
('Benito Juárez'),
('Coyoacán'),
('Cuajimalpa de Morelos'),
('Cuauhtémoc'),
('Gustavo A. Madero'),
('Iztacalco'),
('Iztapalapa'),
('La Magdalena Contreras'),
('Miguel Hidalgo'),
('Milpa Alta'),
('Tláhuac'),
('Tlalpan'),
('Venustiano Carranza'),
('Xochimilco');

-- Álvaro Obregón
INSERT INTO COLONIA (NOMBRE_COLONIA, ID_ALCALDIA) VALUES
('Santa Fe', 1),
('San Ángel', 1),
('Tizapán', 1),
('Olivar del Conde', 1),
('Lomas de Tarango', 1);

-- Azcapotzalco
INSERT INTO COLONIA (NOMBRE_COLONIA, ID_ALCALDIA) VALUES
('Clavería', 2),
('San Álvaro', 2),
('Nextengo', 2),
('Victoria de las Democracias', 2),
('Pasteros', 2);

-- Benito Juárez
INSERT INTO COLONIA (NOMBRE_COLONIA, ID_ALCALDIA) VALUES
('Del Valle', 3),
('Narvarte', 3),
('Portales', 3),
('Nápoles', 3),
('Mixcoac', 3);

-- Coyoacán
INSERT INTO COLONIA (NOMBRE_COLONIA, ID_ALCALDIA) VALUES
('Copilco', 4),
('Villa Coyoacán', 4),
('Ajusco', 4),
('Los Reyes', 4),
('Pedregal de Santo Domingo', 4);

-- Cuajimalpa de Morelos
INSERT INTO COLONIA (NOMBRE_COLONIA, ID_ALCALDIA) VALUES
('El Yaqui', 5),
('San Lorenzo Acopilco', 5),
('Loma del Padre', 5),
('Santa Rosa Xochiac', 5),
('Contadero', 5);

-- Cuauhtémoc
INSERT INTO COLONIA (NOMBRE_COLONIA, ID_ALCALDIA) VALUES
('Roma Norte', 6),
('Juárez', 6),
('Centro', 6),
('Guerrero', 6),
('Doctores', 6);

-- Gustavo A. Madero
INSERT INTO COLONIA (NOMBRE_COLONIA, ID_ALCALDIA) VALUES
('Lindavista', 7),
('San Juan de Aragón', 7),
('Tepeyac Insurgentes', 7),
('La Villa', 7),
('Cuchilla del Tesoro', 7);

-- Iztacalco
INSERT INTO COLONIA (NOMBRE_COLONIA, ID_ALCALDIA) VALUES
('Agrícola Oriental', 8),
('Gabriel Ramos Millán', 8),
('Infonavit Iztacalco', 8),
('Pantitlán', 8),
('Granjas México', 8);

-- Iztapalapa
INSERT INTO COLONIA (NOMBRE_COLONIA, ID_ALCALDIA) VALUES
('Santa María Aztahuacan', 9),
('San Lorenzo Tezonco', 9),
('Cabeza de Juárez', 9),
('El Manto', 9),
('Lomas de Zaragoza', 9);

-- La Magdalena Contreras
INSERT INTO COLONIA (NOMBRE_COLONIA, ID_ALCALDIA) VALUES
('San Jerónimo Lídice', 10),
('Barranca Seca', 10),
('La Malinche', 10),
('El Ocotal', 10),
('San Nicolás Totolapan', 10);

-- Miguel Hidalgo
INSERT INTO COLONIA (NOMBRE_COLONIA, ID_ALCALDIA) VALUES
('Polanco', 11),
('Anzures', 11),
('Tacuba', 11),
('San Miguel Chapultepec', 11),
('Lomas de Chapultepec', 11);

-- Milpa Alta
INSERT INTO COLONIA (NOMBRE_COLONIA, ID_ALCALDIA) VALUES
('Villa Milpa Alta', 12),
('San Antonio Tecómitl', 12),
('San Pablo Oztotepec', 12),
('Santa Ana Tlacotenco', 12),
('San Salvador Cuauhtenco', 12);

-- Tláhuac
INSERT INTO COLONIA (NOMBRE_COLONIA, ID_ALCALDIA) VALUES
('San Francisco Tlaltenco', 13),
('Los Olivos', 13),
('Miguel Hidalgo', 13),
('Selene', 13),
('Del Mar', 13);

-- Tlalpan
INSERT INTO COLONIA (NOMBRE_COLONIA, ID_ALCALDIA) VALUES
('Fuentes Brotantes', 14),
('Pedregal de San Nicolás', 14),
('Héroes de Padierna', 14),
('La Joya', 14),
('Miguel Hidalgo 3ra Sección', 14);

-- Venustiano Carranza
INSERT INTO COLONIA (NOMBRE_COLONIA, ID_ALCALDIA) VALUES
('Moctezuma 2da Sección', 15),
('Aviación Civil', 15),
('Pensador Mexicano', 15),
('Balbuena', 15),
('Adolfo López Mateos', 15);

-- Xochimilco
INSERT INTO COLONIA (NOMBRE_COLONIA, ID_ALCALDIA) VALUES
('San Gregorio Atlapulco', 16),
('Santa Cruz Acalpixca', 16),
('San Lorenzo Atemoaya', 16),
('Xaltocan', 16),
('La Noria', 16);

